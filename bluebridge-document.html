<!--
`bluebridge-document`
Fetches a document from the BlueBridge instance, receives update and remove events
-->
<dom-module id="bluebridge-document">
  <template>
  </template>

  <script>
    Polymer({
      is: 'bluebridge-document',

      properties: {
        collection: {
          type: String,
          observer: '_collectionChanged',
        },
        docId: {
          type: String,
          value: '',
          observer: '_idChanged',
          reflectToAttribute: true,
        },
        document: {
          type: Object,
          notify: true,
          observer: '_documentChanged',
          value: {}
        },
        loading: {
          type: Boolean,
          value: false,
          reflectToAttribute: true,
        },
        loaded: {
          type: Boolean,
          value: false,
          reflectToAttribute: true,
        },
        validating: {
          type: Boolean,
          value: false,
          reflectToAttribute: true,
        },
        valid: {
          type: Boolean,
          value: false,
          reflectToAttribute: true,
        },
        invalid: {
          type: Boolean,
          value: false,
          reflectToAttribute: true,
        },
        errors: {
          type: Array,
          value: [],
        },
        autoSave: {
          type: Boolean,
          value: false,
          notify: true,
        },
        saving: {
          type: Boolean,
          value: false,
          reflectToAttribute: true,
        },
        saved: {
          type: Boolean,
          value: false,
          reflectToAttribute: true,
        }
      },

      _collectionChanged: function (collection) {
        this.reload();
      },
      _idChanged: function (docId, oldDocId) {
        if (!this.document) {
          this.reload();
          return;
        }
        if (docId != this.document._id) {
          this.reload();
          return;
        }
      },

      _documentChanged: function (data) {
        if (data) {
          if (data._id && this.docId !== data._id) {
            this.docId = data._id;
            return;
          }
          if (this.autoSave) {
            this.save();
          }
        }
      },

      reload: function () {
        let self = this;
        if (!this.collection) {
          return;
        }
        this.loading = true;
        bluebridge
          .document(this.collection, this.docId)
          .then(function (doc) {
            self.replace(doc);
            self.loading = false;
            self.loaded = true;
            self._documentChanged(this.document);
          });
      },

      replace: function (data) {
        for (var i in this.document) {
          delete this.document[i];
        }
        for (var i in data) {
          this.document[i] = data[i];
        }
      },

      validate: function () {
        let self = this;
        this.validating = true;
        return bluebridge.validateDocument(this.collection, this.docId, this.document)
        .then(function (errors) {
          self.validating = false;
          if (errors) {
            self.valid = false;
            self.invalid = true;
            self.errors = errors;
          } else {
            self.valid = true;
            self.invalid = false;
            self.errors = [];
          }
          return Promise.resolve(self.valid);
        });
      },

      save: function () {
        let self = this;
        this.saving = true;
        this.saved = false;
        return this.validate()
        .then(function (valid) {
          // If not valid return early
          if (!valid) {
            self.saving = false;
            return Promise.resolve(false);
          }
          // Save
          return bluebridge.saveDocument(self.collection, self.docId, self.document)
          .then(function (savedDocument) {
            self.saving = false;
            self.saved = true;
            return Promise.resolve(true);
          });
        });
      }
    });
  </script>
</dom-module>
