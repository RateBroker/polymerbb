<!--
`bluebridge-document`
Fetches a document from the BlueBridge instance, receives update and remove events
-->
<dom-module id="bluebridge-document">
  <template>
  </template>

  <script>
    Polymer({
      is: 'bluebridge-document',

      properties: {
        collection: {
          type: String,
          observer: '_collectionChanged',
        },
        docId: {
          type: String,
          value: null,
          observer: '_idChanged',
          reflectToAttribute: true,
        },
        data: {
          type: Object,
          notify: true,
          observer: '_dataChanged',
          value: {}
        },
        loading: {
          type: Boolean,
          value: false,
          reflectToAttribute: true,
        },
        loaded: {
          type: Boolean,
          value: false,
          reflectToAttribute: true,
        },
        validating: {
          type: Boolean,
          value: false,
          reflectToAttribute: true,
        },
        valid: {
          type: Boolean,
          value: false,
          reflectToAttribute: true,
        },
        invalid: {
          type: Boolean,
          value: false,
          reflectToAttribute: true,
        },
        errors: {
          type: Array,
          value: [],
        },
        autoSave: {
          type: Boolean,
          value: false,
          notify: true,
        },
        saving: {
          type: Boolean,
          value: false,
          reflectToAttribute: true,
        },
        saved: {
          type: Boolean,
          value: false,
          reflectToAttribute: true,
        },
        isNew: {
          type: Boolean,
          computed: '_computeIsNew(docId)'
        },
      },

      ready: function () {
        bluebridge.rpc.socket.on('connect',     this.reload.bind(this));
        bluebridge.rpc.socket.on('auth',        this.reload.bind(this));
        bluebridge.rpc.socket.on('deauth',      this.reload.bind(this));
        bluebridge.rpc.socket.on('disconnect',  this.reload.bind(this));
      },

      _collectionChanged: function (collection) {
        this.reload();
      },
      _idChanged: function (docId, oldDocId) {
        if (!this.data) {
          this.reload();
          return;
        }
        if (docId != this.data._id) {
          this.reload();
          return;
        }
      },
      _dataChanged: function (data) {
        if (this.autoSave) {
          return this.save();
        }
        if (data && data._id && this.docId !== data._id) {
          this.docId = data._id;
          return;
        }
        return Promise.resolve();
      },
      _computeIsNew: function (docId) {
        return docId === null;
      },

      reload: function () {
        let self = this;

        if (!this.collection) { return; }

        this.loading = true;

        var documentPromise = this.isNew ?
          bluebridge.create(this.collection) :
          bluebridge.document(this.collection, this.docId);

        return documentPromise
          .then((data) => {
            self.loading = false;
            self.loaded = true;
            this.set('data', data);
          })
          .then(true);
      },

      replace: function (data) {
        for (var i in this.data) {
          delete this.data[i];
        }
        for (var i in data) {
          this.data[i] = data[i];
        }
        return Promise.resolve(this.data);
      },

      save: function () {
        let self = this;

        this.saving = true;
        this.saved = false;

        return this.validate()
          .then(() => bluebridge.save(self.collection, self.docId, self.data))
          .then(data => {
            self.saving = false;
            self.saved = true;
            self.docId = data._id;
            this.set('data', data);
            return this.data;
          });
      },

      validate: function () {
        let self = this;
        this.validating = true;
        return bluebridge.validate(this.collection, this.docId, this.data)
          .then(function (errors) {
            self.validating = false;
            if (errors) {
              self.valid = false;
              self.invalid = true;
              self.errors = errors;
              return Promise.reject(errors);
            } else {
              self.valid = true;
              self.invalid = false;
              self.errors = [];
              return Promise.resolve();
            }
          });
      },

      method: function (methodName) {
        return bluebridge.method(this.collection, this.docId, methodName);
      },

      static: function (staticName) {
        return bluebridge.static(this.collection, staticName);
      }
    });
  </script>
</dom-module>
