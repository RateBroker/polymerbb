<!--
`bluebridge-query`
Fetches an array of document ids from the BlueBridge instance
-->
<dom-module id="bluebridge-query">
  <template>
  </template>

  <script>
    Polymer({

      is: 'bluebridge-query',

      properties: {
        collection: {
          type: String,
          observer: '_collectionChanged',
        },
        query: {
          type: Object,
          observer: '_queryChanged',
          notify: true,
        },
        results: {
          type: Array,
          notify: true,
          value: [],
        },
        loading: {
          type: Boolean,
        },
      },

      ready: function () {
        bluebridge.rpc.socket.on('connect',     this.reload.bind(this));
        bluebridge.rpc.socket.on('auth',        this.reload.bind(this));
        bluebridge.rpc.socket.on('deauth',      this.reload.bind(this));
        bluebridge.rpc.socket.on('disconnect',  this.reload.bind(this));
      },

      _collectionChanged: function (collection) {
        this.reload();
      },

      _queryChanged: function (query) {
        this.reload();
      },

      reload: function () {
        if (!this.collection) {
          return;
        }
        this.loading = true;
        this.loaded = false;
        bluebridge.query(this.collection, this.query)
          .then((results) => {
            this.loading = false;
            this.loaded = true;
            this.set('results', results);
          });
      },

      static: function (staticName) {
        return bluebridge.static(this.collection, staticName);
      },

    });
  </script>
</dom-module>
